## 背景

由于gpt返回的json不是非常稳定，有时候返回的数据有一点小瑕疵，例如返回的字段没有双引号，或者是中文的冒号不识别，多输出/少输出花括号（方括号）导致的格式层次不对，自动换行且换行符不可解析（undefined错误），自动输出代码块，未完整输出，输出内容格式无法解析等等原因。导致使用string转json就是会直接失败，但是利用gpt4处理的成本有不能不管，本着能用尽量用的原则，尝试对错误的json也解析一下。

## 先看数据，进行分析

```json
[{"评分项':"观点正确","采分点":[{"采分点":"城管本意为维护城市环境，出发点正确，但方式不妥，需要注意","得分":"2","思考":"学员的回答完全命中了这个采分点。他们明确指出城管的目标是保持城市环境的文明、清洁和新鲜，但也批评了他们的行动方式，认为过于粗暴，并建议他们应该更加重视与公众的沟通和引导。","相关内容":["支队目的是为了维护城市环境的文明、洁净和清新","民众质疑这一行动过于粗暴"]}]},{"评分项":"分析透彻","采分点":[{"采分点":"执法的不足","得分":"1","思考":"学员指出执法过程中存在问题，但没有详细说明具体的不足之处。","相关内容":["民众质疑这一行动过于粗暴"]},{"采分点":"民众不理解，忽视民众感受","得分":"2","思考":"学员对此有深入理解，提到了公众对执法行为的误解，并强调了对公众情绪的关注。","相关内容":["民众质疑这一行动过于粗暴"]},{"采分点":"城管执法简单粗暴，存在乱作为，越权管理，缺乏灵活变通，制止传统习俗","得分":"2","思考":"学员在回答中直接指出了城管执法简单粗暴等问题，符合采分点要求。","相关内容":["民众质疑这一行动过于粗暴"]},{"采分点":"进行的本意","得分":"1","思考":"学员提到了城管工作的初衷，但未进一步阐述其具体含义或背后意图。","相关内容":["支队目的是为了维护城市环境的文明、洁净和清新"]},{"采分点":"营造节日气氛，杜绝安全隐患、视觉污染，维护市容市貌，维护文明、洁净、清新城市环境","得分":"2","思考":"学员很好地捕捉到这个观点，并提供了具体措施以满足公众需求同时保持环境整洁。","相关内容":["可以提供一些替代方案, 如设立指定贴春联区域或提供环保的春联材料, 以满足民众的文化需求，并减少视觉污染和安全隐患"]}],"评分项":"对策清晰","采分点":[{"采分点":"今后执法部门在工作时，需要认真及时回应民众质疑，做到公开透明","得分":"0","思考":"虽然学生在答案中表达了沟通和互动的重要性，但并未特别强调公开透明地处理民众质疑这一措施。","相关内容":[]}],"评分项":"作答逻辑","得分":"2","思考":"学员首先阐述自己的观点，在给出相应理由后再提出建议方案。此种结构条理清晰、逻辑严密"}]
```

看数据的方法：

1. 看到第一个字符是个“\[”,说明我们返回的是list,第二个字符是“{”,说明整体是个list含有多个object。

2. 我们抽一个object来看看，有"评分项"对应值是一个文本，采分点对应又是一个list,而子一层的是又是一个object,小的object又有采分点对应值是string，得分对应string，思考对应string，相关内容对应list,内部是string，看起来有结构的时候还能看一点。但是如果不能解析就比较难处理了。

   ```json
   {
    "评分项":"观点正确",
    "采分点":[
        {
            "采分点":"城管本意为维护城市环境，出发点正确，但方式不妥，需要注意",
            "得分":"2",
            "思考":"学员的回答完全命中了这个采分点。他们明确指出城管的目标是保持城市环境的文明、清洁和新鲜，但也批评了他们的行动方式，认为过于粗暴，并建议他们应该更加重视与公众的沟通和引导。",
            "相关内容":[
                "支队目的是为了维护城市环境的文明、洁净和清新",
                "民众质疑这一行动过于粗暴"
            ]
        }
    ]
    }
   ```

3. 目前看直接转为json，一点点的转，难度也不小，不知道哪里结束，不知道哪里开始，不好办。那我们从小做起，先全部按照k-v的方式来处理。我要做的就只剩下，判断哪里是key,判断哪里是value，全部查看后确定如下，虽然json乱但是“评分项|采分点|得分|思考|相关内容”这几个还是要作为key，这是要使用到的格式。然后就是value,其他的不就都是value了吗？

## 实践验证

1. 我们先定义下我们的key:(评分项|采分点|得分|思考|相关内容)

2. 然后就是找value,简单的就是(.\*),但是目前看还有一些要过滤下，我不要 *\[\]{}*, 这个明显是json的分割用的那我们优化为：
   (\[^\\\[\\{\\\]\\}\]+?)
   我要把key和value区分开，关键字是“：:”,那我们初步的正则就有了：

   ``` 
   (评分项|采分点|得分|思考|相关内容)[:：]([^\\[\\{\\]\\}]+?)
   ```

   这里测试的时候有个问题，结束位置不对，那我们再加个结束位置。(?=评分项|采分点|得分|思考|相关内容|\\\]|\\})，这里用?=是相等但是不获取，我们采用了关键字和“\]}”来作为结束。那现在正则改为：

   ```
   (评分项|采分点|得分|思考|相关内容)[:：]([^\\[\\{\\]\\}]+?)(?=评分项|采分点|得分|思考|相关内容|\\]|\\})
   ```

3. 按照刚才的正则基本上就已经满足了，但是我们还要稍微优化下，例如不要单双引号和逗号，那再进行一次优化。最终形态如下：

   ```
   (评分项|采分点|得分|思考|相关内容)[\"”‘’']?[:：][\"”‘’'\\[]{0,2}([^\\[\\{\\]\\}]+?)[\"”‘’',，]+(?=评分项|采分点|得分|思考|相关内容|\\]|\\})")
   ```

## 总结

处理正则从大的方向出发，或者从小的地方着手都行，主要就是发现数据的规律，再不断调试优化，基本上就可以写出来不错的正则。现在看这个正则是不是也能看懂了，还是比较简单的对吧。
当然正则也不是万能的，如果真的复杂的不行，获取可以看看是否有其他的方式。

### 后记，java中获取两个匹配项的方式

```java
String input = "[{}]";
Pattern re = Pattern.compile("(评分项|采分点|得分|思考|相关内容)[\"”‘’']?[:：][\"”‘’'\\[]{0,2}([^\\[\\{\\]\\}]+?)[\"”‘’',，]+(?=评分项|采分点|得分|思考|相关内容|\\]|\\})");
Matcher m = re.matcher(input);
while (m.find()) {
    // m.group()是匹配的内容
    System.out.println(m.group());
    // m.group(1)是对应的key， m.group(2)对应的是value
    System.out.println(m.group(1) + " : " + m.group(2));
}
```